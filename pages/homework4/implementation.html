<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv="X-UA-Compatible" content="ie=edge">
		<link rel="icon" type="image/x-icon" href="assets/img/favicon.ico">
		<link href="https://fonts.googleapis.com/css?family=Roboto+Mono%7CArvo:400%7CRoboto:300,400,500,700%7CCookie" rel="stylesheet">
		<link rel="stylesheet" href="../../ui/vendor/css/fontawesome.min.css">
		<link rel="stylesheet" href="../../ui/vendor/perfect-scrollbar.css">
		<link rel="stylesheet" href="../../ui/css/style.css">
		<script src="../../ui/vendor/d3.v5.min.js"></script>
		<title>CS360/560 Data Visualization</title>
	<style>
		#tree-container {
			background-color: #030619;
			font-size: 0;
		}
		.tree-tooltip {
			min-width: 100px;
			background-color: #fff;
			border-radius: 3px;
			padding: 10px;
			font-size: 13px;
			font-weight: 400;
			fill: black;
			color: black;
			stroke: none;
			text-align: center;
			border: 1px solid black;
		}
		.pack-tooltip {
			background-color: rgba(255, 255, 255, 0.95);
			border-radius: 3px;
			padding: 10px;
			font-size: 13px;
			font-weight: 400;
			fill: black;
			color: black;
			stroke: none;
			border: 1px solid black;
		}
		.pack-tooltip table {
			width: 100%;
			text-align: left;
		}
		.pack-tooltip table th {
			font-size: 14px;
		}
		.info-table {
			background-color: rgba(0, 255, 255, 0.5);
			width: 400px;
			color: #000;
		}
		.info-table th {
			white-space: nowrap;
		}
		.info-table tr {
			vertical-align: top;
		}
		.legend-title {
			font-size: 16px;
		}
		.legend-label {
			font-size: 12px;
		}
	</style>
	</head>
	<body>
		<div class="full-page">
			<div class="sidebar-container">
				<aside  class="sidebar sidebar-left sidebar-fixed sidebar-dark">
					<div class="scroll">
						<div class="sidebar-header text-white bg-info">
							<div class="sidebar-brand d-flex justify-content-between align-items-center">
								<div class="title text-truncate">
									Data Visulization
								</div>
								<div class="logo align-items-center justify-content-around">
									<i class="material-icons">all_inclusive</i>
								</div>
							</div>
						</div>
						<div class="sidebar-nav-container">
							<ul class="list-nav sidebar-nav list-nav-dark list-nav-dark-info">
								<li class="list-nav-group-title">
									<span>
									  HOMEWORK 4
									</span>
								</li>
								<li class="list-nav-item">
									<a href="../../" class="list-nav-link">
									  <span class="list-nav-icon">
										<i class="material-icons">home</i>
									  </span>
									  <span class="list-nav-label">Home</span>
									</a>
								</li>
								<li class="list-nav-item">
									<a href="#" class="list-nav-link">
									  	<span class="list-nav-icon">
											<i class="material-icons">folder_open</i>
									  	</span>
									  	<span class="list-nav-label">Homework 1</span>
									  	<span class="list-nav-expand">
											<i class="material-icons">add</i>
									  	</span>
									</a>
									<ul class="list-nav-child">
										<li class="list-nav-item list-nav-child-item">
										  <a href="../homework1/overview.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Overview</span>
										  </a>
										</li>
										<li class="list-nav-item list-nav-child-item">
										  <a href="../homework1/prototypes.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Tableau Prototypes</span>
										  </a>
										</li>
										<li class="list-nav-item list-nav-child-item">
										  <a href="../homework1/d3-bar.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">D3 Implementations</span>
										  </a>
										</li>
										<li class="list-nav-item list-nav-child-item">
										  <a href="../homework1/requirements.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Requirements</span>
										  </a>
										</li>
									</ul>
								</li>
								<li class="list-nav-item">
									<a href="#" class="list-nav-link">
									  	<span class="list-nav-icon">
											<i class="material-icons">folder_open</i>
									  	</span>
									  	<span class="list-nav-label">Homework 2</span>
									  	<span class="list-nav-expand">
											<i class="material-icons">add</i>
									  	</span>
									</a>
									<ul class="list-nav-child">
										<li class="list-nav-item list-nav-child-item">
										  <a href="../homework2/overview.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Overview</span>
										  </a>
										</li>
										<li class="list-nav-item list-nav-child-item">
										  <a href="../homework2/scatterplot-matrix.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Scatterplot Matrix</span>
										  </a>
										</li>
										<li class="list-nav-item list-nav-child-item">
										  <a href="../homework2/requirements.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Requirements</span>
										  </a>
										</li>
									</ul>
								</li>
								<li class="list-nav-item">
									<a href="#" class="list-nav-link">
									  	<span class="list-nav-icon">
											<i class="material-icons">folder_open</i>
									  	</span>
									  	<span class="list-nav-label">Homework 3</span>
									  	<span class="list-nav-expand">
											<i class="material-icons">add</i>
									  	</span>
									</a>
									<ul class="list-nav-child">
										<li class="list-nav-item list-nav-child-item">
										  <a href="../homework3/overview.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Overview</span>
										  </a>
										</li>
										<li class="list-nav-item list-nav-child-item">
										  <a href="../homework3/implementation.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Implementations</span>
										  </a>
										</li>
										<li class="list-nav-item list-nav-child-item">
										  <a href="../homework3/requirements.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Requirements</span>
										  </a>
										</li>
									</ul>
								</li>
								<li class="list-nav-item">
									<a href="#" class="list-nav-link">
									  	<span class="list-nav-icon">
											<i class="material-icons">folder_open</i>
									  	</span>
									  	<span class="list-nav-label">Homework 4</span>
									  	<span class="list-nav-expand">
											<i class="material-icons">add</i>
									  	</span>
									</a>
									<ul class="list-nav-child">
										<li class="list-nav-item list-nav-child-item">
										  <a href="overview.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Overview</span>
										  </a>
										</li>
										<li class="list-nav-item list-nav-child-item">
										  <a href="implementation.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Implementations</span>
										  </a>
										</li>
										<li class="list-nav-item list-nav-child-item">
										  <a href="requirements.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Requirements</span>
										  </a>
										</li>
									</ul>
								</li>
								<li class="list-nav-item">
									<a href="#" class="list-nav-link">
									  	<span class="list-nav-icon">
											<i class="material-icons">folder_open</i>
									  	</span>
									  	<span class="list-nav-label">Midterm</span>
									  	<span class="list-nav-expand">
											<i class="material-icons">add</i>
									  	</span>
									</a>
									<ul class="list-nav-child">
										<li class="list-nav-item list-nav-child-item">
										  <a href="../midterm/prototype.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Prototype</span>
										  </a>
										</li>
										<li class="list-nav-item list-nav-child-item">
										  <a href="../midterm/implementation.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Implementation</span>
										  </a>
										</li>
									</ul>
								</li>
								<li class="list-nav-item">
									<a href="#" class="list-nav-link">
									  	<span class="list-nav-icon">
											<i class="material-icons">folder_open</i>
									  	</span>
									  	<span class="list-nav-label">Final</span>
									  	<span class="list-nav-expand">
											<i class="material-icons">add</i>
									  	</span>
									</a>
									<ul class="list-nav-child">
										<li class="list-nav-item list-nav-child-item">
										  <a href="../final/overview.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Overview</span>
										  </a>
										</li>
										<li class="list-nav-item list-nav-child-item">
										  <a href="../final/about.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">About</span>
										  </a>
										</li>
										<li class="list-nav-item list-nav-child-item">
										  <a href="../final/dataset.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Dataset</span>
										  </a>
										</li>
										<li class="list-nav-item list-nav-child-item">
										  <a href="../final/alpha.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Alpha Release</span>
										  </a>
										</li>
										<li class="list-nav-item list-nav-child-item">
										  <a href="../final/beta.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Beta Release</span>
										  </a>
										</li>
										<li class="list-nav-item list-nav-child-item">
										  <a href="../final/final.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Final Release</span>
										  </a>
										</li>
										<li class="list-nav-item list-nav-child-item">
										  <a href="../final/requirements.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Requirements</span>
										  </a>
										</li>
									</ul>
								</li>
							</ul>
						</div>
					</div>
				</aside>
			</div>
			<div class="page">
				<div class="topbar-container">
					<nav class="navbar bg-white text-secondary navbar-expand-sm py-0 topbar fixed">
						<button class="btn btn-flat-secondary btn-sm btn-icon mr-1 no-shadow d-none d-xl-block sidebar-toggle">
							<i class="material-icons">menu</i>
						</button>
						<button class="btn btn-flat-secondary btn-sm btn-icon mr-1 d-xl-none no-shadow sidebar-hide">
							<i class="material-icons">menu</i>
						</button>

						<div class="navbar-text ml-3 d-none d-sm-block">
							<h5 class="m-0 text-dark">Homework 4</h5>
						</div>

						<div class="ml-auto d-sm-flex ml-3">
							<ul class="navbar-nav">
								<li class="nav-item no-caret">
									<a href="../about.html" class="nav-link text-center">About</a>
								</li>
								<li class="nav-item no-caret">
									<a href="../resources.html" class="nav-link text-center">Resources</a>
								</li>
								<li class="nav-item no-caret">
									<a href="https://jakezhong.com" target="_blank" class="nav-link text-center">
										<i class="far fa-globe"></i>
									</a>
								</li>
								<li class="nav-item no-caret">
									<a href="https://github.com/jakezhong" target="_blank" class="nav-link text-center">
										<i class="fab fa-github"></i>
									</a>
								</li>
								<li class="nav-item no-caret">
									<a href="https://www.linkedin.com/in/jake-zhong/" target="_blank" class="nav-link text-center">
										<i class="fab fa-linkedin-in"></i>
									</a>
								</li>
								<li class="nav-item no-caret">
									<a href="https://www.instagram.com/jakezhong_" target="_blank" class="nav-link text-center">
										<i class="fab fa-instagram"></i>
									</a>
								</li>
								<li class="nav-item no-caret">
									<a href="https://www.facebook.com/jksakura" target="_blank" class="nav-link text-center">
										<i class="fab fa-facebook"></i>
									</a>
								</li>
							</ul>
						</div>
					</nav>
				</div>
				<div class="page-content">
					<section class="section">
						<div class="container">
							<h1 class="section-title">Homework 4 Implementation</h1>
						  	<!-- Begin page content -->
						  	<div class="content">
								<hr class="space"/>
								<h3 class="section-title">Data Encoding</h3>
								<h4>Tree</h4>
								<ul>
									<li>
										Tree Levels
										<ul>
											<li><b>1st level: </b>fire department</li>
											<li><b>2nd level: </b>neighborhoods</li>
											<li><b>3td level: </b>call types</li>
										</ul>
									</li>
									<li>
										Colors
										<ul>
											<li><b>White: </b>the parent node - fire department and neighborhoods</li>
											<li><b>Other colors: </b>the children node - call types</li>
										</ul>
									</li>
									<li>
										Links
										<ul>
											<li><b>Left side: parent node</b></li>
											<li><b>Right side: child node</b></li>
										</ul>
									</li>
									<li>
										Legends: different colors for call types
									</li>
								</ul>
								<h4>Pack</h4>
								<ul>
									<li>
										Sizes
										<ul>
											<li><b>Large circle(background): </b>fire department</li>
											<li><b>Medium circle: </b>neighborhoods</li>
											<li><b>Small circle: </b>call types</li>
										</ul>
									</li>
									<li>
										Colors
										<ul>
											<li><b><span style="color: #142e57">Blue: </b></span>Fire Department</li>
											<li><b><span style="color: #ff4040">Red: </b></span>Neighborhoods</li>
											<li><b><span style="color: #ffffb2">Light Yellow: </b></span>Call Types</li>
										</ul>
									</li>
								</ul>
								<hr class="space"/>
								<h3 class="section-title top-space">Interactivity Guide</h3>
								<h4 class="section-title top-space">Tree</h4>
								<h5 class="section-title top-space">Tooltip</h5>
								<figure>
									<p><img src="../../assets/img/homework4/interactivity1.gif" alt=""></p>
									<figcaption>Hovering on a node will wake the details-on-demand interactivity, which will display the name of the node and the number of records of the node.</figcaption>
								</figure>
								<h4 class="section-title top-space">Pack</h4>
								<h5 class="section-title top-space"></h5>
								<figure>
									<p><img src="../../assets/img/homework4/interactivity2.gif" alt=""></p>
									<figcaption>Hovering on a circle will wake the details-on-demand interactivity, which will display the name and the numbers of recordsof of the neighborhood and the names and numbers of records of all call types in this neighborhood.</figcaption>
								</figure>
								<h5 class="section-title top-space">Zooming</h5>
								<figure>
									<p><img src="../../assets/img/homework4/interactivity3.gif" alt=""></p>
									<figcaption>Clicking on any of the circle will zoom in the circle and display the specific name of the call types.</figcaption>
								</figure>
								<hr class="space"/>
								<h3 class="section-title">Data Wrangling</h3>
								<h4 class="section-title top-space">API Request Filter and Sorting</h4>
								<p>In the website of the fire department, I did some data wrangling to narrow down my dataset, I used the filter to only select the data from the Feb 2020 and sorter them by the number of call types, so they will have the same order in each neighborhood.</p>
								<h4 class="section-title top-space">Convert the fire depatment records to a hierarchical format (SF fire department records -> Neighborhoods -> Call Types)</h4>
								<p>The original dataset doesn’t have a hierarchy based on the neighborhoods and call types. Although there are some ways to wrangle it in d3, I decided to wrangle it with vanilla JavaScript considering the hierarchy that I need only has three levels.</p>
								<p>So, I fetched all the records of Feb 2020 with the API and sorted them by call types(making sure they follow the same order). I created a new object of the fire department, and store each neighborhood as its children, and each neighborhood also has a list of children, which is a list of different call types. While loading the records, each record will be saved to the list of neighborhoods and the list of call types in that neighborhood.</p>
								<script src="https://gist.github.com/jakezhong/85e81d4786d37e18d20b72decceaf0a0.js"></script></script>
								<hr class="space"/>
								<h3 class="section-title">Conclusion</h3>
								<p>In the month of February 2020, the fire department has 1,000 records. Based on the records, there 38 neighborhoods and 14 call types on the list. Most of the records are medical incidents and Tenderloin has the largest amount of records(163) among all the neighborhoods.</p>
								<hr class="space"/>
								<h3 class="section-title">Attribution</h3>
									<p>For this project, I referred some D3 examples, such as tree and pack modeling, legend, color scale and zooming interactivity on the web.</p>
									<h4 class="section-title top-space">References</h4>
									<p>
										<a href="https://github.com/d3/d3-hierarchy#tree" target="_blank">D3 Hierarchy Tree Example</a><br/>
										<a href="https://github.com/d3/d3-hierarchy#pack" target="_blank">D3 Hierarchy Pack Example</a><br/>
										<a href="https://www.d3-graph-gallery.com/graph/custom_legend.html" target="_blank">D3 Graph Gallery: D3 Legend Example</a><br/>
										<a href="https://observablehq.com/@d3/zoomable-circle-packing" target="_blank">Zoomable Circle Packing</a><br/>
										<a href="https://bl.ocks.org/hepplerj/f2f4e5f4a9321428b11614674c741177" target="_blank">Threshold scale</a><br/>
										<a href="https://observablehq.com/@d3/color-schemes" target="_blank">Color Schemes</a>
									</p>
								<hr class="space"/>
								<h3 class="section-title">D3 Implementations</h3>
								<div class="card work-images">
									<div class="card-body card-body-p">
									  	<div class="chart-container">
									  		<div class="implementation-container">
												<h4 class="section-title">D3 Hierarchical Tree of Fire department Call Records in Feb 2020 by Neighborhoods and Call Types.</h4>
												<svg id="tree-container">
													<g id="tree"></g>
													<g id="tooltip" pointer-events="none"></g>
													<g id="details" pointer-events="none"></g>
													<g id="legend" pointer-events="none"></g>
												</svg>
												<h4 class="section-title top-space">D3 Hierarchical Pack of Fire department Call Records in Feb 2020 by Neighborhoods and Call Types.</h4>
												<svg id="pack-container">
													<g id="pack"></g>
													<g id="tooltip-pack" pointer-events="none"></g>
													<g id="details-pack" pointer-events="none"></g>
													<g id="legend-pack" pointer-events="none"></g>
												</svg>
									  		</div>
									  	</div>
									</div>
								</div>
					  		</div>
						  <!-- End page content -->
						</div>
					</section>
				</div>
			</div>
		</div>
		<script src="https://d3js.org/d3-hierarchy.v1.min.js"></script>
		<script>
			const url = "https://data.sfgov.org/resource/nuek-vuh3.json";
			
			// Data wrangling
			let data = {
				"name": "Fire Department",
				"number": 0,
				"children": []
			};
			
			let callTypes = [];
				
			let colorScale;
			
			// Data loading and wrangling
			d3.json(url).then(function(json) {
				json.forEach(function(d) {
					
					data.number = data.number + 1;

					if (callTypes.indexOf(d.call_type) < 0) {
						callTypes.push(d.call_type);
					}

					let neighborhoods = data.children.map(function(neighborhood) {
						return neighborhood.name;
					});
					
					let indexN = neighborhoods.indexOf(d.neighborhoods_analysis_boundaries);
					
					if (indexN > -1) {
					
						data.children[indexN].number = data.children[indexN].number + 1;
						
						let types = data.children[indexN].children.map(function(type) {
							return type.name;
						});

						let indexT = types.indexOf(d.call_type);

						if (indexT > -1) {
							data.children[indexN].children[indexT].number = data.children[indexN].children[indexT].number + 1;
						} else {
							let newType = {
								"name": d.call_type,
								"number": 1
							}
							
							data.children[indexN].children.push(newType);
						}
					} else {
						let newType = {
							"name": d.call_type,
							"number": 1
						}

						let newNeighborhood = {
							"name": d.neighborhoods_analysis_boundaries,
							"number": 1,
							"children": [newType]
						}

						data.children.push(newNeighborhood);
					}
				});
//				console.log(data);
//				console.log(callTypes);
				
				// Draw tree
				drawTree(data);
				
				// Draw pack
				drawPack(data);
			});
			
			function tree(data) {
				// Draw svg
				let width = 960;
				let height = 1600;
				const root = d3.hierarchy(data);
				
				root.dx = 10;
				root.dy = width / (root.height + 1);
				
				return d3.tree().nodeSize([root.dx, root.dy])(root);
			}
			
			function drawTree(data) {
				// Draw svg
				let width = 960;
				let height = 1600;
				
				const svg = d3
					.select(".implementation-container")
					.select("svg#tree-container")
					.attr("x", 0)
					.attr("width", width)
					.attr("height", height);
				
				// Initialize color scale
				colorScale = d3
				.scaleOrdinal()
				.domain(callTypes)
				.range(["#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c","#fdbf6f","#ff7f00","#cab2d6","#6a3d9a","#a6cee3","#b15928"]);
				
				// Draw g
				const g = {
					tree: svg.select("g#tree"),
					tooltip: svg.select("g#tooltip"),
					details: svg.select("g#details"),
					legend: svg.select("g#legend")
				};

//				 setup tooltip (shows neighborhood name)
				const tip = g
					.tooltip
					.append("foreignObject")
					.attr("class", "tree-tooltip");

				tip.attr("text-anchor", "end");
				tip.attr("dx", 0);
				tip.attr("dy", 0);
				tip.attr("width", 250);
				tip.attr("height", 60);
				tip.style("visibility", "hidden");
				
				// Draw tree
				const root = tree(data);
				
				let x0 = Infinity;
				let x1 = -x0;
				
				root.each(d => {
					if (d.x > x1) x1 = d.x;
					if (d.x < x0) x0 = d.x;
				});

				svg.attr("viewBox", [0, 0, width, x1 - x0 + root.dx * 2]);

				g.tree
					.attr("font-family", "sans-serif")
					.attr("font-size", 10)
					.attr("transform", `translate(${root.dy / 3},${root.dx - x0})`);

				const link = g.tree.append("g")
					.attr("fill", "none")
					.attr("stroke", "#fff")
					.attr("stroke-opacity", 0.4)
					.attr("stroke-width", 1.5)
					.selectAll("path")
					.data(root.links())
					.join("path")
					.attr("d", d3.linkHorizontal()
						.x(d => d.y)
						.y(d => d.x));

				const node = g.tree.append("g")
					.attr("stroke-linejoin", "round")
					.attr("stroke-width", 3)
					.selectAll("g")
					.data(root.descendants())
					.join("g")
					.attr("transform", d => `translate(${d.y},${d.x})`);

				node.append("circle")
//					.attr("fill", d => d.children ? "#555" : "#999")
					.attr("fill", function(d) {
						if (callTypes.indexOf(d.data.name) > -1) {
							return colorScale(d.data.name);
						} else {
							return d.children ? "#fff" : "#999";
						}
					})
					.attr("r", 3);

				node.append("text")
					.attr("dy", "0.31em")
					.attr("x", d => d.children ? -10 : 10)
					.attr("text-anchor", d => d.children ? "end" : "start")
					.text(d => d.data.name)
//					.clone(true).lower()
					.style("fill", function(d) {
						if (callTypes.indexOf(d.data.name) > -1) {
							return colorScale(d.data.name);
						}
						
						return "#fff";
					});

//			  // add tooltip
				node.on("mouseover", function(d) {
					console.log(d);
					let html = d.data.name;
					html += "<br># of calls: " + d.data.number;

					tip.html(html);
					tip.style("visibility", "visible");
					tip.attr("x", d.y);
					tip.attr("y", d.x + 700);
					tip.style("color", function() {
						if (callTypes.indexOf(d.data.name) > -1) {
							return colorScale(d.data.name);
						}
					});
				})
				.on("mouseout", function(d) {
					tip.style("visibility", "hidden");
				});
				
				drawTreeLegend(svg);
				
  				return g.tree.node();
			}
			
			function drawTreeLegend(svg) {
				let legend_size = 12;

				// Add one dot in the legend for each name.

				svg.selectAll("legend-rects")
					.data(callTypes)
					.enter()
					.append("rect")
					.attr("x", 20)
					.attr("y", function(d,i){ return i * (legend_size+5) - 25})
					.attr("width", legend_size)
					.attr("height", legend_size)
					.attr("class", "legend-rect")
					.style("fill", function(d) { return colorScale(d); });

				// Add one dot in the legend for each name.
				svg.selectAll("legend-labels")
					.data(callTypes)
					.enter()
					.append("text")
					.attr("x", legend_size * 1.5 + 20)
					.attr("y", function(d,i){ return i * (legend_size+5) + (legend_size/2) - 25})
					.text(function(d){ return d; })
					.attr("text-anchor", "left")
					.style("alignment-baseline", "middle")
					.attr("class", "legend-label")
					.style("fill", function(d) { return colorScale(d); });

			}
			
			function pack(data) {
				// Draw svg
				let width = 960;
				let height = 960;
				
				let pack = d3
					.pack()
					.size([width, height])
					.padding(3)
					(d3.hierarchy(data)
					.sum(d => d.number)
					.sort((a, b) => b.number - a.number));
				
				return pack;
				
			}
			
			function drawPack(data) {
				// Draw svg
				let width = 960;
				let height = 960;
				
				const svg = d3
					.select(".implementation-container")
					.select("svg#pack-container")
					.attr("x", 0)
					.attr("width", width)
					.attr("height", height);
				
				color = d3.scaleLinear()
					.domain([0, 1, 2])
					.range(["#142e57", "#ff4040"])
					.interpolate(d3.interpolateHcl)
				
				// Draw g
				const g = {
					pack: svg.select("g#pack"),
					tooltip: svg.select("g#tooltip-pack"),
					details: svg.select("g#details-pack"),
					legend: svg.select("g#legend-pack")
				};

//				 setup tooltip (shows neighborhood name)
				const tip = g
					.tooltip
					.append("foreignObject")
					.attr("class", "pack-tooltip");

				tip.attr("text-anchor", "end");
				tip.attr("dx", 0);
				tip.attr("dy", 0);
				tip.attr("width", 250);
				tip.attr("height", 250);
				tip.style("visibility", "hidden");
				
				const root = pack(data);
				let focus = root;
				let view;
				
				svg.attr("viewBox", `-${width / 2} -${height / 2} ${width} ${height}`)
					.style("display", "block")
					.style("background", color(0))
					.style("cursor", "pointer")
					.on("click", () => zoom(root));

				const node = g.pack.append("g")
					.selectAll("circle")
					.data(root.descendants().slice(1))
					.join("circle")
					.attr("fill", d => d.children ? color(d.depth) : "#ffffb2")
					.attr("pointer-events", d => !d.children ? "none" : null)
					.on("mouseover", function(d) {
						d3.select(this).attr("stroke", "#fff");
						
						console.log(d);
						let html = "<table>";
						html += "<tr><th>" + d.data.name + "</th><th>" + d.data.number + "</th></tr>";
						if (d.children.length > 0) {
							d.children.forEach(function(el) {
	//							console.log(el);
								html += "<tr><td>" + el.data.name + "</td><td>" + el.data.number + "</td></tr>";
							});
						}
						html += "</table>";
						tip.html(html);
						tip.style("visibility", "visible");
						tip.attr("x", function() {
							let newX = d.x - 605;
							
							if (newX < -480) {
								return -480;
							} else if (newX > 230) {
								return 230;
							} else {
								return newX;
							}
						});
						tip.attr("y", function() {
							let newY = d.y - 605;
							
							if (newY < -480) {
								return -480;
							} else if (newY > 230) {
								return 230;
							} else {
								return newY;
							}
						});
					})
					.on("mouseout", function() {
						d3.select(this).attr("stroke", null);
						tip.style("visibility", "hidden");
					})
					.on("click", d => focus !== d && (zoom(d), d3.event.stopPropagation()));

				const label = g.pack.append("g")
					.style("font", "10px sans-serif")
					.attr("pointer-events", "none")
					.attr("text-anchor", "middle")
					.selectAll("text")
					.data(root.descendants())
					.join("text")
					.style("fill-opacity", d => d.parent === root ? 1 : 0)
					.style("display", d => d.parent === root ? "inline" : "none")
					.text(d => d.data.name);
				
//				console.log(root);
				
				zoomTo([root.x, root.y, root.r * 2]);

				function zoomTo(v) {
					const k = width / v[2];

					view = v;
					
					label.attr("transform", function(d) {
						
						return `translate(${(d.x - v[0]) * k},${(d.y - v[1]) * k})`
					});
					node.attr("transform", function(d) {
						
						return `translate(${(d.x - v[0]) * k},${(d.y - v[1]) * k})`;
					});
					node.attr("r", function(d) {
						
						return d.r * k;
					});
				}

				function zoom(d) {
					const focus0 = focus;

					focus = d;

					const transition = svg.transition()
						.duration(d3.event.altKey ? 7500 : 750)
						.tween("zoom", d => {
							const i = d3.interpolateZoom(view, [focus.x, focus.y, focus.r * 2]);
							return t => zoomTo(i(t));
						});

					label
						.filter(function(d) { return d.parent === focus || this.style.display === "inline"; })
						.transition(transition)
						.style("fill-opacity", d => d.parent === focus ? 1 : 0)
						.on("start", function(d) { if (d.parent === focus) this.style.display = "inline"; })
						.on("end", function(d) { if (d.parent !== focus) this.style.display = "none"; });
				}

				drawPackLegend(svg);
				
				return svg.node();
			}
			
			function drawPackLegend(svg) {
				let legend_size = 12;
				// Initialize color scale
				let titles = ["Fire Department", "Neighborhood", "Call Type"];
				let color = d3
					.scaleOrdinal()
					.domain(titles)
					.range(["#142e57", "#ff4040", "#ffffb2"]);

				// Add one dot in the legend for each name.
				
				svg
					.append("rect")
					.attr("x", -460)
					.attr("y", -460)
					.attr("width", 140)
					.attr("height", 66)
					.style("fill", "#999");
				
				svg.selectAll("legend-rects")
					.data(titles)
					.enter()
					.append("rect")
					.attr("x", -450)
					.attr("y", function(d,i){ return i * (legend_size+5) - 450})
					.attr("width", legend_size)
					.attr("height", legend_size)
					.attr("class", "legend-rect")
					.style("fill", function(d) {
						return color(d);
					});

				// Add one dot in the legend for each name.
				svg.selectAll("legend-labels")
					.data(titles)
					.enter()
					.append("text")
					.attr("x", legend_size * 1.5 - 450)
					.attr("y", function(d,i){ return i * (legend_size+5) + (legend_size/2) - 450})
					.text(function(d){ return d; })
					.attr("text-anchor", "left")
					.style("alignment-baseline", "middle")
					.attr("class", "legend-label")
					.style("fill", function(d) { return color(d); });

			}
		</script>
		<script src="../../ui/vendor/jquery.min.js"></script>
		<script src="../../ui/vendor/popper.min.js"></script>
		<script src="../../ui/vendor/bootstrap.min.js"></script>
		<script src="../../ui/vendor/perfect-scrollbar.min.js"></script>
		<script src="../../ui/vendor/hammer.min.js"></script>
		<script src="../../ui/vendor/jquery-ui/jquery-ui.min.js"></script>
		<script src="../../ui/vendor/color/color.min.js"></script>
		<script src="../../ui/vendor/fontawesome.min.js"></script>
		<script src="../../ui/scripts/sidebar.min.js"></script>
		<script src="../../ui/scripts/collapsible-nav.min.js"></script>
		<script src="../../ui/scripts/colors.min.js"></script>
		<script src="../../ui/scripts/settings.min.js"></script>
		<script src="../../ui/scripts/card.min.js"></script>
		<script src="../../ui/scripts/script.js"></script>
	</body>
</html>
